package vn.edu.iuh.fit.service.implement;import com.amazonaws.auth.AWSStaticCredentialsProvider;import com.amazonaws.auth.BasicAWSCredentials;import com.amazonaws.services.s3.AmazonS3;import com.amazonaws.services.s3.AmazonS3ClientBuilder;import com.amazonaws.services.s3.model.CannedAccessControlList;import com.amazonaws.services.s3.model.PutObjectRequest;import jakarta.annotation.PostConstruct;import org.modelmapper.ModelMapper;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.beans.factory.annotation.Value;import org.springframework.cache.annotation.Cacheable;import org.springframework.data.domain.Page;import org.springframework.data.domain.PageImpl;import org.springframework.data.domain.PageRequest;import org.springframework.data.domain.Pageable;import org.springframework.data.jpa.repository.JpaRepository;import org.springframework.hateoas.PagedModel;import org.springframework.data.web.PagedResourcesAssembler;import org.springframework.hateoas.server.RepresentationModelAssembler;import org.springframework.stereotype.Service;import org.springframework.transaction.annotation.Transactional;import org.springframework.util.StringUtils;import org.springframework.web.multipart.MultipartFile;import vn.edu.iuh.fit.dto.TourDetailDTO;import vn.edu.iuh.fit.dto.TourSummaryDTO;import vn.edu.iuh.fit.entity.*;import vn.edu.iuh.fit.enums.ParticipantType;import vn.edu.iuh.fit.enums.TourType;import vn.edu.iuh.fit.exception.ResourceNotFoundException;import vn.edu.iuh.fit.repositories.TourRepository;import vn.edu.iuh.fit.service.AbstractCrudService;import vn.edu.iuh.fit.service.TourService;import java.io.File;import java.io.IOException;import java.math.BigDecimal;import java.time.LocalDate;import java.util.ArrayList;import java.util.HashSet;import java.util.List;import java.util.UUID;import java.util.stream.Collectors;@Service@Transactionalpublic class TourServiceImpl extends AbstractCrudService<Tour, Long> implements TourService {    @Autowired    private TourRepository tourRepository;    private final ModelMapper modelMapper;//    @Autowired//    private PagedResourcesAssembler<Tour> pagedResourcesAssembler;    @Value("${aws.s3.bucket}")    private String bucketName;    @Value("${aws.access.key}")    private String accessKey;    @Value("${aws.secret.key}")    private String secretKey;    @Value("${aws.region}")    private String region;    private AmazonS3 s3Client;    @Autowired    public TourServiceImpl(TourRepository tourRepository, ModelMapper modelMapper) {        this.tourRepository = tourRepository;        this.modelMapper = modelMapper;    }    @PostConstruct    public void initializeAmazonS3Client() {        if (StringUtils.isEmpty(accessKey) || StringUtils.isEmpty(secretKey)) {            throw new IllegalStateException("AWS credentials not properly configured");        }        BasicAWSCredentials awsCredentials = new BasicAWSCredentials(accessKey, secretKey);        this.s3Client = AmazonS3ClientBuilder.standard()                .withCredentials(new AWSStaticCredentialsProvider(awsCredentials))                .withRegion(region)                .build();    }    @Override    protected JpaRepository<Tour, Long> getRepository() {        return tourRepository;    }    @Override    public List<Tour> findToursByDestination(Destination destination) {        return null;    }@Overridepublic Page<TourSummaryDTO> getTours(String keyword, int page, int size, BigDecimal minPrice, BigDecimal maxPrice,                                     String tourTypeStr, String startLocation, String participantTypeStr) {    Pageable pageable = PageRequest.of(page, size);    Page<Object[]> results;    TourType tourType = null;    ParticipantType participantType = null;    if (tourTypeStr != null && !tourTypeStr.isEmpty()) {        try {            tourType = TourType.valueOf(tourTypeStr.toUpperCase());        } catch (IllegalArgumentException e) {            throw new IllegalArgumentException("Invalid tour type: " + tourTypeStr);        }    }    if (participantTypeStr != null && !participantTypeStr.isEmpty()) {        try {            participantType = ParticipantType.valueOf(participantTypeStr.toUpperCase());        } catch (IllegalArgumentException e) {            throw new IllegalArgumentException("Invalid participant type: " + participantTypeStr);        }    }    if (keyword != null && !keyword.isEmpty()) {        // Keyword search        results = tourRepository.findtTourByKeyword(keyword, pageable);    } else if (tourType != null || startLocation != null || participantType != null) {        // Multi-criteria search        results = tourRepository.searchTours(minPrice, maxPrice, tourType, startLocation, participantType, pageable);    } else {        // Default price-based search        results = tourRepository.findToursWithPriceRange(minPrice, maxPrice, pageable);    }    return results.map(result -> {        TourSummaryDTO dto = new TourSummaryDTO();        Tour tour = (Tour) result[0];        TourPricing tourPricing = (TourPricing) result[1];        LocalDate startDate = (LocalDate) result[2];        Integer availableSeats = (Integer) result[3];        String imageUrl = (String) result[4];        dto.setTourId(tour.getTourId());        dto.setTourName(tour.getTourName());        dto.setTourDescription(tour.getTourDescription());        dto.setDuration(tour.getDuration());        dto.setStartLocation(tour.getStartLocation());        dto.setPrice(tourPricing.getPrice());        dto.setStartDate(startDate);        dto.setAvailableSeats(availableSeats);        dto.setImageUrl(imageUrl);        return dto;    });}    @Cacheable("tour")    public TourDetailDTO getTourById(long id) {        Tour tour = tourRepository.findById(id)                .orElseThrow(() -> new ResourceNotFoundException("Tour not found"));        return modelMapper.map(tour, TourDetailDTO.class);    }    public Tour convertDtoToEntity(TourDetailDTO tourDetailDTO) {        return modelMapper.map(tourDetailDTO, Tour.class);    }    @Override    public String uploadImageToAWS(File file, Tour tour) throws IOException {        String fileName = UUID.randomUUID() + "_" + file.getName();        try {            s3Client.putObject(new PutObjectRequest(bucketName, fileName, file));//                    .withCannedAcl(CannedAccessControlList.PublicRead);            String fileUrl = s3Client.getUrl(bucketName, fileName).toString();            Image image = new Image();            if (tour.getImages() == null) {                tour.setImages(new HashSet<>());            }            image.setImageUrl(fileUrl);            image.setTour(tour);            tour.getImages().add(image);            tourRepository.save(tour);            return fileUrl;        } catch (Exception e) {            throw new IOException("Error uploading image: " + e.getMessage(), e);        } finally {            // Dọn dẹp file tạm thời nếu cần            if (file.exists()) {                file.delete();            }        }    }    // Phương thức chuyển đổi MultipartFile thành File    @Override    public File convertMultiPartToFile(MultipartFile file) throws IOException {        File convFile = new File(System.getProperty("java.io.tmpdir") + "/" + file.getOriginalFilename());        file.transferTo(convFile);        System.out.println("File được tạo: " + convFile.getAbsolutePath());        return convFile;    }//    @Override//    public List<Tour> searchTours(String keyword) {//        return tourRepository.findByTourNameContainingIgnoreCaseOrStartLocationContainingIgnoreCase(keyword, keyword);//    }}