package vn.edu.iuh.fit.controller;import lombok.RequiredArgsConstructor;import org.springframework.data.domain.Page;import org.springframework.format.annotation.DateTimeFormat;import org.springframework.http.HttpStatus;import org.springframework.http.ResponseEntity;import org.springframework.web.bind.annotation.*;import vn.edu.iuh.fit.dto.*;import vn.edu.iuh.fit.dto.request.TourGuideAssignmentRequestDTO;import vn.edu.iuh.fit.dto.request.UpdateStatusRequest;import vn.edu.iuh.fit.entity.TourGuide;import vn.edu.iuh.fit.entity.TourGuideAssignment;import vn.edu.iuh.fit.service.TourGuideService;import vn.edu.iuh.fit.enums.AssignStatus;import java.time.LocalDateTime;import java.util.List;import java.util.Map;@RestController@RequestMapping("/api/tour-guides")@RequiredArgsConstructor@CrossOrigin(origins = "*", allowedHeaders = "*")public class TourGuideController {    private final TourGuideService tourGuideService;    @GetMapping    public List<TourGuide> getAllTourGuides() {        return tourGuideService.getAllTourGuides();    }    @GetMapping("/{guideId}/assignments")    public ResponseEntity<List<TourAssignmentDTO>> getGuideAssignments(            @PathVariable Long guideId,            @RequestParam(required = false) AssignStatus status    ) {        return ResponseEntity.ok(tourGuideService.getGuideAssignments(guideId, status));    }    @GetMapping("/assignments-all")    public ResponseEntity<Page<TourAssignmentDTO>> getAllAssignments(            @RequestParam(defaultValue = "0") int page,            @RequestParam(defaultValue = "10") int size) {        Page<TourAssignmentDTO> response = tourGuideService.getAllAssignments(page, size);        return ResponseEntity.ok(response);    }    @PutMapping("/{guideId}/assignments/{departureId}/status")    public ResponseEntity<Void> updateAssignmentStatus(            @PathVariable Long guideId,            @PathVariable Long departureId,            @RequestBody UpdateStatusRequest request    ) {        AssignStatus status = request.getStatus();        tourGuideService.updateAssignmentStatus(guideId, departureId, status);        return ResponseEntity.ok().build();    }    @GetMapping("/statistics")    public ResponseEntity<TourGuideAssignmentStatisticsDTO> getSystemAssignmentStatistics() {        TourGuideAssignmentStatisticsDTO statistics = tourGuideService.getSystemAssignmentStatistics();        return ResponseEntity.ok(statistics);    }    @GetMapping("/working-hours")    public ResponseEntity<List<TourGuideWorkingHoursDTO>> getWorkingHours(            @RequestParam("startDate") @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME) LocalDateTime startDate,            @RequestParam("endDate") @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME) LocalDateTime endDate) {        if (startDate.isAfter(endDate)) {            throw new IllegalArgumentException("Thời gian bắt đầu không được sau thời gian kết thúc");        }        List<TourGuideWorkingHoursDTO> workingHours = tourGuideService.getTotalWorkingHoursByTourGuides(startDate, endDate);        return ResponseEntity.ok(workingHours);    }    @GetMapping("/{userId}/kpi")    public TourGuideKPIDTO getKPI(@PathVariable long userId) {        return tourGuideService.getKPI(userId);    }    @PutMapping()    public ResponseEntity<Void> updateTourGuide(@RequestBody TourGuideUpdateDTO updateDTO) {        tourGuideService.updateTourGuide(updateDTO);        return ResponseEntity.noContent().build();    }    @PutMapping("/{guideId}/assignments/{departureId}")    public ResponseEntity<Void> updateTourAssignment(@PathVariable Long guideId,                                                     @PathVariable Long departureId,                                                     @RequestBody TourAssignmentDTO updateDTO) {        tourGuideService.updateTourAssignment(guideId, departureId, updateDTO);        return ResponseEntity.noContent().build();    }    @DeleteMapping("/{guideId}/assignments/{departureId}")    public ResponseEntity<Void> deleteTourAssignment(@PathVariable Long guideId,                                                     @PathVariable Long departureId) {        tourGuideService.deleteTourGuideAssignment(guideId, departureId);        return ResponseEntity.noContent().build();    }    @PostMapping("/assign-tour-guide")    public ResponseEntity<List<TourGuideAssignment>> assignTourGuides(@RequestBody TourGuideAssignmentRequestDTO requestDTO) {        List<TourGuideAssignment> assignments = tourGuideService.assignTourGuide(requestDTO);        return ResponseEntity.ok(assignments);    }    @GetMapping("/schedule/{tourGuideId}")    public ResponseEntity<List<TourScheduleDTO>> getTourScheduleByGuide(@PathVariable Long tourGuideId) {        List<TourScheduleDTO> tourSchedule = tourGuideService.getToursByGuide(tourGuideId);        if (tourSchedule == null) {            return ResponseEntity.status(HttpStatus.NOT_FOUND).body(null);        }        return ResponseEntity.ok(tourSchedule);    }    @PostMapping("/attendance")    public ResponseEntity<String> markAttendance(@RequestBody AttendanceDTO attendanceDTO) {        try {            tourGuideService.markAttendance(attendanceDTO);            return ResponseEntity.ok("Điểm danh thành công cho hướng dẫn viên với ID: " + attendanceDTO.getUserId());        } catch (Exception e) {            return ResponseEntity.badRequest().body("Lỗi: " + e.getMessage());        }    }}